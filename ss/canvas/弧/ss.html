<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        .box {
            width: 600px;
            height: 600px;
            position: relative;
        }

        .min-box {
            width: 10px;
            height: 10px;
            position: absolute;
            background-color: pink;
        }
    </style>
</head>

<body>
    <div class="box">
        <div class="min-box slider"></div>
        <canvas id="canvas"></canvas>
    </div>
    <script>
        var My = function () {
            this.canvas = document.querySelector('#canvas')
            this.box = this.canvas.parentElement
            this.slider = this.box.querySelector('.slider') // 滑块
            this.sliderInfo = this.slider.getBoundingClientRect()
            this.boxInfo = this.box.getBoundingClientRect()
            this.ctx = this.canvas.getContext('2d')
            this.time = 10
            // this.startAngle = -(this.getArcValue(90)) // 开始的角度
            this.endAngle = 0 // 结束的角度
            this.circularX = 100 // 圆心的 x 轴坐标
            this.circularY = 400 // 圆心的 y 轴坐标
            this.radius = 100 // 半径
            this.isPressDow = false // 鼠标默认是抬起的状态

            console.log(this.getArcValue(90), this.startAngle)

            this.init()
        }

        // 初始化
        My.prototype.init = function () {
            this.setBoxSize() // 设置盒子大小
            this.pressDown() // 鼠标按下滑块的事件
            this.mousemove() // 鼠标按下并且移动滑块的事件
            this.mouseup() // 鼠标抬起时执行的方法
            this.arcDrawing({
                startAngle: -90,
                endAngle: 180
            }) // 画弧
            this.setSpotCoordinate({
                angle: 180
            }) // 设置点的位置
        }

        // 设置盒子大小
        My.prototype.setBoxSize = function () {
            this.canvas.width = this.boxInfo.width
            this.canvas.height = this.boxInfo.height
        }

        /**
         * 动态画弧
         * @param {object} params 
         * @param {number} params.endAngle      结束的角度
         *
         */
        My.prototype.arcDrawing = function (params) {
            // this.ctx.strokeStyle = 'red'
            // this.ctx.lineWidth = 6
            let startArc = this.getArcValue(params.startAngle)
            let temp = params.startAngle

            var clearId = setInterval(() => {
                if (temp >= params.endAngle) {
                    clearInterval(clearId)
                    return false
                }

                let eAngle = this.getArcValue(temp) // 结束的弧度
                this.ctx.clearRect(0, 0, this.boxInfo.width, this.boxInfo.height) // 在给定的矩形内清除指定的像素
                this.ctx.beginPath() // 开始新的一条路径
                this.ctx.arc(this.circularX, this.circularY, this.radius, startArc, eAngle)
                this.ctx.stroke()
                temp++
            }, 10)

            this.endAngle = params.endAngle // 更新最后的角度
        }

        /**
         * 补全-画弧 
         * @param {object} params 
         * @param {number} params.startAngle    开始的角度
         * @param {number} params.endAngle      结束的角度
         */
        My.prototype.ad = function(params) {
            this.ctx.clearRect(0, 0, this.boxInfo.width, this.boxInfo.height) // 在给定的矩形内清除指定的像素
            let startArc = this.getArcValue(params.startAngle) // 开始的弧度
            let endArc = this.getArcValue(params.endAngle) // 结束的弧度
            this.ctx.beginPath() // 开始新的一条路径
            this.ctx.arc(this.circularX, this.circularY, this.radius, startArc, endArc)
            this.ctx.stroke()
        }

        /**
         *  计算弧度
         *  @param  {number}        angle 角度
         *  @return {number}        弧度
         *
         */
        My.prototype.getArcValue = function (angle) {
            let arc = Math.abs(angle) * Math.PI / 180
            if(angle > 0) {
                return arc
            } else {
                return -arc
            }
        }

        /*
         * 获取圆上的坐标
         * @param   {number} angle
         * @return  {object} coordinate 坐标 { x: value, y: value }
         */
        My.prototype.getCoordinate = function (angle) {
            let sAngle = 0
            let rightAngle = this.radius / Math.sin(2 * Math.PI / 360 * 90) // 直角

            if (angle <= 90) {
                sAngle = 90 - angle
                return {
                    x: this.circularX + Math.sin(2 * Math.PI / 360 * sAngle) * rightAngle - this.sliderInfo.width /
                        2,
                    y: this.circularY + Math.sin(2 * Math.PI / 360 * angle) * rightAngle - this.sliderInfo.height /
                        2
                }
            } else if (angle <= 180) {
                sAngle = 90 - (180 - angle)
                return {
                    x: this.circularX - Math.sin(2 * Math.PI / 360 * sAngle) * rightAngle - this.sliderInfo.width /
                        2,
                    y: this.circularY + Math.sin(2 * Math.PI / 360 * (180 - angle)) * rightAngle - this.sliderInfo
                        .height / 2
                }
            } else if (angle <= 270) {
                sAngle = 270 - angle
                return {
                    x: this.circularX - Math.sin(2 * Math.PI / 360 * sAngle) * rightAngle - this.sliderInfo.width / 2,
                    y: this.circularY - Math.sin(2 * Math.PI / 360 * (180 - sAngle - 90)) * rightAngle - this.sliderInfo.height / 2
                }
            } else if (angle <= 360) {
                sAngle = 90 - (360 - angle)
                return {
                    x: this.circularX + Math.sin(2 * Math.PI / 360 * sAngle) * rightAngle - this.sliderInfo.width /
                        2,
                    y: this.circularY - Math.sin(2 * Math.PI / 360 * (360 - angle)) * rightAngle - this.sliderInfo
                        .height / 2
                }
            }
        }

        /*
         * 设置点的位置
         * @param {object}  params
         * @param {angle}   params.angle 角度
         */
        My.prototype.setSpotCoordinate = function (params) {
            let coordinate = this.getCoordinate(params.angle)
            this.slider.style.left = coordinate.x + 'px'
            this.slider.style.top = coordinate.y + 'px'
        }

        /**
         * 已知一个点求角度
         * 获取角度
         * @param {Object} params.x x 轴坐标
         * @param {Object} params.y y 轴坐标
         * @return {number} 角度
         */
        My.prototype.getAngle = function (params) {
            let sinA = Math.sin(2 * Math.PI / 360 * 90)
            // let ab = 129 488
            let ab = params.y - this.circularY
            let oa = params.x - this.circularX
            let sino = sinA * ab / Math.sqrt(Math.pow(oa, 2) + Math.pow(ab, 2))
            params.sin = sino
            return this.getSinAngle(params)
        }

        /**
         * 获取 sin 角度
         * @param {object} params.sin   传入一个 sin 值
         * @param {object} params.x     传入一个元素所在的 x 轴坐标
         * @param {object} params.y     传入一个元素所在的 y 轴坐标
         * @return {number} angle
         * 正切 || 正弦 || 余弦也可用同理求出
         */
        My.prototype.getSinAngle = function (params) {
            console.log(params, this.circularX, this.circularY)
            if(params.x > this.circularX && params.y > this.circularY) {
                console.log('0-90')
                return Math.asin(params.sin) / (Math.PI / 180)
            } else if(params.x > this.circularX && params.y < this.circularY) {
                console.log('270-360')
                return 360 + Math.asin(params.sin) / (Math.PI / 180)
            } else if(params.x < this.circularX && params.y < this.circularY) {
                console.log('180-270')
                return 180 - Math.asin(params.sin) / (Math.PI / 180)
            } else if(params.x < this.circularX && params.y > this.circularY) {
                console.log('90-180')
                return 180 - Math.asin(params.sin) / (Math.PI / 180)
            }
        }

        /**
         * 给滑块注册鼠标按下事件
         */
        My.prototype.pressDown = function () {
            let that = this
            console.log('>????')
            that.slider.addEventListener('mousedown', function (event) {
                // 利用传参兼容火狐
                let e = window.event || event
                // 获取目标元素
                let target = e.target ? e.target : e.srcElement
                // 获取元素标签内容
                let className = event.target.className
                console.log(className)
                if (className.includes('slider')) {
                    that.isPressDown = true // 开启
                    // that.slider.style.position = 'fixed' // 设置固定定位，以便移动
                }
            })
        }

        // 鼠标滑动时执行
        My.prototype.mousemove = function () {
            let that = this
            window.onmousemove = function (event) {
                // 利用传参兼容火狐
                let e = window.event || event
                // 获取目标元素
                let target = e.target ? e.target : e.srcElement
                // 获取元素标签内容
                let tagName = event.target.tagName

                // 分别兼容ie和chrome
                let scrollX = document.documentElement.scrollLeft || document.body.scrollLeft
                let scrollY = document.documentElement.scrollTop || document.body.scrollTop
                // 获取 x 和 y
                let x = e.clientX + scrollX - that.sliderInfo.width
                let y = e.clientY + scrollY - that.sliderInfo.height

                if (that.isPressDown) {
                    // that.slider.style.left = x + 'px'
                    // that.slider.style.top = y + 'px'
                    // 获取当前鼠标的角度
                    let angle = that.getAngle({
                        x: x,
                        y: y
                    })
                    // 获取当前元素在圆上的位置
                    let coordinate = that.getCoordinate(angle)
                    // 设置位置
                    that.slider.style.left = coordinate.x + 'px'
                    that.slider.style.top = coordinate.y + 'px'

                    that.ad({
                        startAngle: -90,
                        endAngle: angle
                    })

                    console.log(angle, '当前的角度')
                    console.log(angle / 360 * 100, '百分比')
                }
            }
        }

        // 鼠标抬起事件
        My.prototype.mouseup = function () {
            let that = this
            window.onmouseup = function (event) {
                // 修改按下的状态
                that.isPressDown = false
                // 利用传参兼容火狐
                let e = window.event || event
                // 获取目标元素
                let target = e.target ? e.target : e.srcElement
                console.log(target, 'target')
                // 获取元素标签内容
                let className = target.getAttribute('class')
                // 分别兼容ie和chrome
                let scrollX = document.documentElement.scrollLeft || document.body.scrollLeft
                let scrollY = document.documentElement.scrollTop || document.body.scrollTop
                // 获取 x 和 y
                let x = e.clientX + scrollX - that.sliderInfo.width
                let y = e.clientY + scrollY - that.sliderInfo.height

                if (className && className.includes('slider')) {
                    // 获取当前鼠标的角度
                    let angle = that.getAngle({
                        x: x,
                        y: y
                    })
                    // 更新结束的角度
                    that.endAngle = angle
                    // 获取当前元素在圆上的位置
                    let coordinate = that.getCoordinate(angle)
                    // 设置位置
                    that.slider.style.left = coordinate.x + 'px'
                    that.slider.style.top = coordinate.y + 'px'
                }
            }
        }


        new My()
    </script>
</body>

</html>