<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title></title>
        <link rel="stylesheet" href="./index.css">
        <script src="https://www.jscss.cc/static/js/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.js"></script>
    </head>
    <body>
        <div style="display: none;">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display: none;">
                <symbol width="18px" height="15px" viewBox="0 0 18 15" id="scissors">
                    <g stroke="none" stroke-width="1" fill-rule="evenodd">
                        <g transform="translate(-1, 0)" fill-rule="nonzero">
                            <path d="M2.15139089,8.38696897 L1.91979391,8.71622093 C1.82573347,8.85259217 1.747064,9.04286222 1.75341717,9.25766058 C1.75611298,9.47578279 1.83626757,9.70492248 1.99014535,9.93835622 C2.21526822,10.2766834 2.61375827,10.6373187 3.23698308,11.0074902 L8.49561842,14.2943297 L8.39785704,11.7465765 L2.15143659,8.38694861 L2.15139089,8.38696897 Z" transform="translate(5.124338, 11.340639) rotate(-60.000000) translate(-5.124338, -11.340639) "></path>
                            <path d="M17.7652914,4.46752066 L17.7652431,4.46751993 L13.0240642,7.1401352 L11.2387239,6.1976818 L12.328745,5.52569376 C12.6889461,5.26756795 12.8106272,5.08248958 12.9145273,4.81569308 C13.0125666,4.54560875 13.0545837,4.15963242 13.1175106,3.63341907 C13.2136669,2.89362972 13.3936644,2.13753272 13.8657151,1.50729544 C14.3329666,0.878579852 15.0993739,0.455665739 16.119138,0.394457167 C16.129798,0.396223297 16.1423476,0.394809179 16.1530076,0.396575309 C17.1698622,0.333708189 17.9005097,0.562048647 18.3614926,1.02753532 C18.8224756,1.49302199 18.9577317,2.13886796 18.935999,2.75996027 C18.9259589,3.09207943 18.8387729,3.43583428 18.6328664,3.72984427 C18.4269599,4.02385426 18.1386514,4.24632745 17.7719803,4.46281871 L17.7652914,4.46752066 Z M15.1290676,2.21180718 L15.1290793,2.21178742 C14.1736859,2.78199619 13.7779625,3.99968446 14.2474991,4.93016396 L17.7082091,2.86915701 C17.2405323,1.93550677 16.0873706,1.64325696 15.1290676,2.21180718 Z"></path>
                            <path d="M12.1672181,10.1256747 L12.1671934,10.1256344 L10.5886029,9.2949512 L1.36187119,4.44394758 L1.56048322,4.05716725 C1.6409747,3.8954413 1.7802081,3.72023593 1.97629538,3.59380722 C2.17429059,3.46420851 2.41762161,3.38961961 2.69483037,3.37625466 C3.10333123,3.35210514 3.60191435,3.45871458 4.21550844,3.739592 L7.53094441,5.14777213 L12.2462304,7.62832976 L12.2405849,7.637831 C12.2244763,7.65834493 12.210264,7.67570861 12.197095,7.69787158 C12.1166035,7.85959753 12.1699213,8.04571562 12.3208605,8.11350844 L12.6150003,8.24896673 L17.5516683,10.5539704 L17.559407,10.5540978 C17.9083257,10.7287144 18.1811419,10.919766 18.3682471,11.1893915 C18.5534743,11.4621776 18.6178623,11.793831 18.6040728,12.1323012 C18.584218,12.750233 18.3998172,13.415208 17.9066639,13.9365007 C17.408693,14.4593049 16.656924,14.772202 15.6409158,14.8270896 C14.6048344,14.8960531 13.8540975,14.5635768 13.4240767,13.9803484 C12.9950874,13.401939 12.8698556,12.6603963 12.8240781,11.9296357 C12.7981611,11.4084429 12.7841488,11.0248257 12.704495,10.7648321 C12.6210853,10.5111596 12.5090139,10.3385407 12.1672181,10.1256747 Z M14.0303205,10.4446766 C13.488648,11.428522 13.7911657,12.6072715 14.7074627,13.0748703 C15.6189606,13.5439908 16.8020015,13.1226121 17.3455519,12.1356063 L14.0303205,10.4446766 Z" id="合并形状"></path>
                        </g>
                    </g>
                </symbol>
            </svg>
        </div>
        <div id="app">
            <svg id="line-box" xmlns="http://www.w3.org/2000/svg" version="1.1" :width="size[0]" :height="size[1]" ref="svg">
                <template v-for="(item, index) in points">
                    <g class="line" :identity="item.start + '&' + item.end" :s-junction="item.sJunction" :e-junction="item.eJunction">
                        <polyline :points="item.coordinate" :key="index" marker-end="url(#arrow)" @click="deleteLine(index)"></polyline>
                        <use xlink:href="#scissors" width="19" height="16" fill="blue" style="display: none"></use>
                    </g>
                </template>
            </svg>
            <div class="content">
                <div class="item" v-for="i in 9" :key="i">
                    <div class="item-content" :id="'item_' + i" v-if="i != 5">
                        {{ i }}
                        <i class="junction item-top"></i>
                        <i class="junction item-right"></i>
                        <i class="junction item-bottom"></i>
                        <i class="junction item-left"></i>
                    </div>
                </div>
                <table rules="all" class="table-path">
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </table>
            </div>
        </div>

        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>  
        <script>
            function main(){
                new Vue({
                    el: '#app',
                    data: {
                        size: [0, 0],
                        polyline: [
                            // {
                            //     start: 'item_6', end: 'item_9', sJunction: 'bottom', eJunction: 'top'
                            // },
                            // {
                            //     start: 'item_1', end: 'item_9', sJunction: 'right', eJunction: 'left'
                            // },
                            // {
                            //     start: 'item_7', end: 'item_4', sJunction: 'left', eJunction: 'left'
                            // },
                        ],
                        points: [
                            {
                                start: 'item_6', end: 'item_9', sJunction: 'bottom', eJunction: 'top'
                            }
                        ], // 连线的坐标
                        limitedScope: [], // 限制范围
                        width: 100,
                        height: 100,
                        itemEle: null, // 元素
                        isDown: false, // 判断鼠标是否抬起
                    },
                    mounted() {
                        this.getEleAllPoints() // 获取所有元素的坐标范围
                        this.dragAndDrop() // 拖拽

                        this.setPaper()
                        const self = this
                        // $(window).on('resize', function(){
                        //     self.setPaper()
                        // })
                    },
                    methods: {
                        // 设置画布容器大小
                        setPaper() {
                            let ele = document.getElementById('app')
                            let width = window.getComputedStyle(ele, null).width
                            let height = window.getComputedStyle(ele, null).height
                            this.size = [width, height]
                        },
                        // getPoints(data) {
                        //     let start = $(`#${data.start}`)[0] // 获取开始的元素
                        //     let end = $(`#${data.end}`)[0] // 获取结束的元素
                        //     let point = this.drawLine(start, end, data.sJunction, data.eJunction) // 画线
                        //     return point
                        // },
                        // 获取所有元素的坐标范围
                        getEleAllPoints() {
                            let ele = $('.content .item')
                            this.itemEle = ele
                            for(let i = 0, length = ele.length; i < length; i++) {
                                let obj = ele[i].getBoundingClientRect()
                                this.limitedScope.push({
                                    top: obj.top,
                                    left: obj.left
                                })
                            }
                        },
                        // 拖拽
                        dragAndDrop() {
                            let vueObj = this

                            let My = function() {
                                this.box = document.querySelector('.content')       // 最外层的盒子元素
                                this.svg = d3.select('#line-box')                   // 获取 svg 元素
                                this.line = null                                    // 提示线条
                                this.startEle = null                                // 开始元素
                                this.endEle = null                                  // 结束元素
                                this.width = 100                                    // 盒子的宽
                                this.height = 100                                   // 盒子的高
                                this.sJunction = null                               // 开始元素的方向
                                this.eJunction = null                               // 结束元素的方向
                                this.isDrag = false                                 // 拖动
                                this.cloneEle = null                                // 克隆内容元素
                                this.parentEle = null                               // 盒子元素
                                this.isPressDown = false                            // 按下 默认 false || 抬起的状态
                                this.end_x = 0                                      // 鼠标 x 轴坐标
                                this.end_y = 0                                      // 鼠标 y 轴坐标
                                this.deleteEle = null                               // 剪刀 || 删除的元素
                                this.polylineEle = null                             // 滑过的线条元素
                                this.init()                                         // 初始化
                            }

                            // 初始化
                            My.prototype.init = function() {
                                this.initialize(vueObj.points)      // 初始化连线
                                this.pressDown()                    // 鼠标按下
                                this.mousemove()                    // 鼠标移动
                                this.mouseup()                      // 鼠标抬起事件
                            }

                            // 鼠标按下
                            My.prototype.pressDown = function() {
                                let that = this
                                this.box.addEventListener('mousedown', function(event) {
                                    // 修改按下的状态
                                    that.isPressDown = true

                                    // 利用传参兼容火狐
                                    let e = window.event || event
                                    // 获取目标元素
                                    let target = e.target ? e.target : e.srcElement
                                    // 获取目标元素的类名
                                    let className = target.className

                                    // 提示线条
                                    that.createTipLine(e)

                                    console.log(className, 'className')

                                    // 判断鼠标按下时的元素
                                    if(className.includes('item-content')) {
                                        // 内容元素
                                        that.isDrag = true
                                        // 获取开始元素
                                        that.startEle = target

                                        // 克隆需要的元素并追加到父元素中
                                        that.parentEle = that.startEle.parentElement
                                        that.cloneEle = that.startEle.cloneNode(true)
                                        that.parentEle.append(that.cloneEle)
                                    } else if(className.includes('junction')) {
                                        // 连接点
                                        // 获取开始元素
                                        that.startEle = target.parentElement
                                        // 获取开始元素的方向
                                        that.sJunction = that.ifDirection(className)
                                    } else {
                                        // 防止点击空元素时连线
                                        that.startEle = null
                                    }
                                })
                            }
                            
                            // 鼠标移动
                            My.prototype.mousemove = function() {
                                let that = this
                                window.onmousemove = function(event) {
                                    // 利用传参兼容火狐
                                    let e = window.event || event
                                    // 获取目标元素
                                    let target = e.target ? e.target : e.srcElement
                                    // 获取元素标签内容
                                    let tagName = event.target.tagName

                                    // 分别兼容ie和chrome
                                    let scrollX = document.documentElement.scrollLeft || document.body.scrollLeft
                                    let scrollY = document.documentElement.scrollTop || document.body.scrollTop
                                    // 获取 x 和 y
                                    that.end_x = e.clientX + scrollX
                                    that.end_y = e.clientY + scrollY

                                    // 划过连线时执行
                                    if(tagName === 'polyline') {
                                        that.polylineEle = target
                                        that.mousemoveConnection()
                                    }

                                    if(that.deleteEle) {
                                        let coordinate = that.polylineEle.getAttribute('points')
                                        if(coordinate.indexOf(that.end_x) === -1 && coordinate.indexOf(that.end_y) === -1 ) {
                                            // 当鼠标不在线条上时隐藏剪刀
                                            that.deleteEle.style.display = 'none'
                                        }
                                    }

                                    // 判断按下的状态
                                    if(!that.isPressDown) {
                                        // 鼠标抬起
                                        return false
                                    }

                                    // 判断提示线条是否存在
                                    if(!that.line) {
                                        // 提示线条不存在
                                        return false
                                    }

                                    // 移动提示线条
                                    that.moveTipLine(e)

                                    // 判断是否需要移动元素
                                    if(that.isDrag) {
                                        that.cloneEle.style.top = that.end_y - that.parentEle.offsetTop - that.height / 2 + 'px'
                                        that.cloneEle.style.left = that.end_x - that.parentEle.offsetLeft - that.width / 2 + 'px'
                                        that.cloneEle.style.zIndex = -1
                                    }
                                }
                            }
                            
                            // 鼠标抬起事件
                            My.prototype.mouseup = function() {
                                let that = this
                                window.onmouseup = function(event) {
                                    // 修改按下的状态
                                    that.isPressDown = false

                                    // 利用传参兼容火狐
                                    let e = window.event || event
                                    // 获取目标元素
                                    let target = e.target ? e.target : e.srcElement
                                    // 获取目标元素的类名
                                    let className = target.className
                                    // 获取目标元素的标签名
                                    let tagName = target.tagName

                                    // 点击线条 || 删除线条
                                    if(tagName === 'polyline') {

                                    } else {
                                        // 判断鼠标抬起时的元素
                                        if(typeof className === 'object') {
                                            // svg || 外面
                                            console.log('error', that.endEle)
                                            // return false
                                        } else if(className.includes('item-content')) {
                                            // 内容元素
                                            console.log('内容元素')
                                            that.endEle = target
                                        } else if(className.includes('junction')) {
                                            // 连接点
                                            console.log(target, target.parentElement, '连接点')
                                            that.endEle = target.parentElement
                                            that.eJunction = that.isDirection(className)
                                            
                                            // 鼠标抬起时清空提示线条
                                            that.line.remove()
                                        } else if(className.includes('item')) {
                                            // 盒子元素
                                            console.log('盒子元素')
                                            that.endEle = target
                                        }

                                        console.log(tagName, 'tagName')

                                        // 鼠标抬起后的复杂逻辑
                                        that.mouseupLogic()

                                        // 重置鼠标状态 || 重新开启连线
                                        that.isDrag = false
                                    }
                                }
                            }

                            // 创建提示线条
                            My.prototype.createTipLine = function(e) {
                                // 分别兼容ie和chrome
                                let scrollX = document.documentElement.scrollLeft || document.body.scrollLeft
                                let scrollY = document.documentElement.scrollTop || document.body.scrollTop
                                // 获取鼠标坐标
                                let x = e.clientX + scrollX
                                let y = e.clientY + scrollY
                                // 创建一条直线并给它设置样式
                                this.line = this.svg.append("line").attr("stroke", "black").attr("stroke-width", "2px").style("z-index", "999").style("position", "absolute")
                                // 设置开始坐标
                                this.line.attr("x1", x).attr("y1", y).attr("x2", x).attr("y2", y)
                            }

                            /**
                             * 画线
                             * @param {Object}      start 开始元素
                             * @param {Object}      end   结束元素
                             * @param {String}      sJunction  开始元素的方向
                             * @param {String}      eJunction  结束元素的方向
                             * 
                             */
                            My.prototype.connection = function(start, end, sJunction, eJunction) {
                                console.log('画线')
                                console.log(start, end, sJunction, eJunction)
                                let that = this
                                let points = []
                                // 分别兼容ie和chrome
                                let scrollX = document.documentElement.scrollLeft || document.body.scrollLeft
                                let scrollY = document.documentElement.scrollTop || document.body.scrollTop
                                let start_top = start.getBoundingClientRect().top + scrollY
                                let start_left = start.getBoundingClientRect().left + scrollX
                                let end_top = end.getBoundingClientRect().top + scrollY
                                let end_left = end.getBoundingClientRect().left + scrollX


                                // 错位连接从下到下
                                let dislocationBB = function (start, end) {
                                    let coordinate = []
                                    if(start_left > end_left) {
                                        // 从右往左
                                        coordinate.push(`${start_left - that.width / 2},${start_top + that.height + that.height / 2}`)
                                        coordinate.push(`${start_left - that.width / 2},${end_top + that.height + that.height / 2}`)
                                        coordinate.push(`${end_left + that.width / 2},${end_top + that.height + that.height / 2}`)
                                        coordinate.push(`${end_left + that.width / 2},${end_top + that.height}`)
                                    } else {
                                        // 从左往右
                                        points.push(`${end_left - that.width / 2},${start_top + that.height + that.height / 2}`)
                                        points.push(`${end_left - that.width / 2},${end_top + that.height + that.height / 2}`)
                                        points.push(`${end_left + that.width / 2},${end_top + that.height + that.height / 2}`)
                                        points.push(`${end_left + that.width / 2},${end_top + that.height}`)
                                    }
                                    
                                    return coordinate
                                }

                                // 同一行
                                let colleague = () => {
                                    console.log('同一行')
                                    // 如果没有选中结束的方向,则自动设置
                                    if(eJunction === null) {
                                        if(sJunction === 'top' || sJunction === 'bottom') {
                                            eJunction = sJunction
                                        }
                                    }

                                    if(Math.abs(start_left - end_left) === this.width * 2) {
                                        // 相邻的
                                        // 判断开始的坐标是否在结束元素的右侧
                                        if(start_left > end_left) {
                                            // 从右往左
                                            if(eJunction === null) {
                                                if(sJunction === 'left') {
                                                    eJunction = 'right'
                                                } else {
                                                    eJunction = 'top'
                                                }
                                            }
                                            
                                            let colleagueRL = () => {
                                                if(sJunction === 'top') {
                                                    points.push(`${start_left + this.width / 2},${start_top}`)
                                                    points.push(`${start_left + this.width / 2},${start_top - this.height / 2}`)
                                                    
                                                    if(eJunction === 'top') {
                                                        points.push(`${end_left + this.width / 2},${start_top - this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${end_top}`)
                                                    } else if(eJunction === 'right') {
                                                        points.push(`${end_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                                        points.push(`${end_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                        points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                                    } else if(eJunction === 'bottom') {
                                                        points.push(`${end_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                                        points.push(`${end_left + this.width + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${end_top + this.height}`)
                                                    } else if(eJunction === 'left') {
                                                        points.push(`${end_left - this.width / 2},${start_top - this.height / 2}`)
                                                        points.push(`${end_left - this.width / 2},${end_top + this.height / 2}`)
                                                        points.push(`${end_left},${end_top + this.height / 2}`)
                                                    }
                                                } else if(sJunction === 'right') {
                                                    points.push(`${start_left + this.width},${start_top + this.height / 2}`)
                                                    points.push(`${start_left + this.width + this.width / 2},${start_top + this.height / 2}`)
                                                    // 右上
                                                    if(eJunction === 'top') {
                                                        points.push(`${start_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${start_top - this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${start_top}`)
                                                    } else if(eJunction === 'right') {
                                                        points.push(`${start_left + this.width + this.width / 2},${start_top  + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width + this.width / 2},${start_top  + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                        points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                                    } else if(eJunction === 'bottom') {
                                                        points.push(`${start_left + this.width + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${start_top + this.height}`)
                                                    } else if(eJunction === 'left') {
                                                        points.push(`${start_left + this.width + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left - this.width  + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left - this.width  + this.width / 2},${start_top + this.height / 2}`)
                                                        points.push(`${end_left},${start_top + this.height / 2}`)
                                                    }
                                                } else if(sJunction === 'bottom') {
                                                    points.push(`${start_left + this.width / 2},${start_top + this.height}`)
                                                    points.push(`${start_left + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                    if(eJunction === 'top') {
                                                        console.log('从下到上')
                                                        points.push(`${end_left + this.width + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width + this.width / 2},${end_top - this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${end_top - this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${end_top}`)
                                                    } else if(eJunction === 'right') {
                                                        points.push(`${end_left + this.width + this.width / 2},${start_top  + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                        points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                                    } else if(eJunction === 'bottom') {
                                                        points.push(`${end_left + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${start_top + this.height}`)
                                                    } else if(eJunction === 'left') {
                                                        points.push(`${end_left - this.width  + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left - this.width  + this.width / 2},${start_top + this.height / 2}`)
                                                        points.push(`${end_left},${start_top + this.height / 2}`)
                                                    }
                                                } else if(sJunction === 'left') {
                                                    points.push(`${start_left},${start_top + this.height / 2}`)
                                                    points.push(`${start_left - this.width / 2},${start_top + this.height / 2}`)
                                                    if(eJunction === 'top') {
                                                        points.push(`${end_left + this.width + this.width / 2},${end_top - this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${end_top - this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${end_top}`)
                                                    } else if(eJunction === 'right') {
                                                        points.push(`${end_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                        points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                                    } else if(eJunction === 'bottom') {
                                                        points.push(`${start_left - this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${start_top + this.height}`)
                                                    } else if(eJunction === 'left') {
                                                        points.push(`${start_left - this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left - this.width  + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left - this.width  + this.width / 2},${start_top + this.height / 2}`)
                                                        points.push(`${end_left},${start_top + this.height / 2}`)
                                                    }
                                                }
                                            }
                                            colleagueRL()
                                        } else {
                                            // 从左往右
                                            if(eJunction === null) {
                                                if(sJunction === 'left') {
                                                    eJunction = 'top'
                                                } else {
                                                    eJunction = 'left'
                                                }
                                            }

                                            let colleagueLR = () => {
                                                if(sJunction === 'top') {
                                                    points.push(`${start_left + this.width / 2},${start_top}`)
                                                    points.push(`${start_left + this.width / 2},${start_top - this.height / 2}`)
                                                    if(eJunction === 'top') {
                                                        points.push(`${end_left + this.width / 2},${start_top - this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${end_top}`)
                                                    } else if(eJunction === 'right') {
                                                        points.push(`${end_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                                        points.push(`${end_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                        points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                                    } else if(eJunction === 'bottom') {
                                                        points.push(`${end_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                                        points.push(`${end_left + this.width + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${end_top + this.height}`)
                                                    } else if(eJunction === 'left') {
                                                        points.push(`${end_left - this.width / 2},${start_top - this.height / 2}`)
                                                        points.push(`${end_left - this.width / 2},${end_top + this.height / 2}`)
                                                        points.push(`${end_left},${end_top + this.height / 2}`)
                                                    }
                                                } else if(sJunction === 'right') {
                                                    console.log('开始是右')
                                                    // points.push(`${start_left + this.width},${start_top + this.height / 2}`)
                                                    // points.push(`${start_left + this.width + this.width / 2},${start_top + this.height / 2}`)
                                                    // 右上
                                                    if(eJunction === 'top') {
                                                        points.push(`${start_left + this.width},${start_top + this.height / 2}`)
                                                        points.push(`${start_left + this.width + this.width / 2},${start_top + this.height / 2}`)
                                                        points.push(`${start_left + this.width + this.width / 2},${end_top - this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${end_top - this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${end_top}`)
                                                    } else if(eJunction === 'right') {
                                                        points.push(`${start_left + this.width + this.width / 2},${start_top  + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width + this.width / 2},${start_top  + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                        points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                                    } else if(eJunction === 'bottom') {
                                                        points.push(`${start_left + this.width + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${start_top + this.height}`)
                                                    } else if(eJunction === 'left') {
                                                        console.log('pkq')
                                                        points.push(`${start_left + this.width},${start_top + this.height / 2}`)
                                                        points.push(`${end_left},${start_top + this.height / 2}`)
                                                        // points.push(`${start_left + this.width + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        // points.push(`${end_left - this.width  + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        // points.push(`${end_left - this.width  + this.width / 2},${start_top + this.height / 2}`)
                                                        // points.push(`${end_left},${start_top + this.height / 2}`)
                                                    }
                                                } else if(sJunction === 'bottom') {
                                                    points.push(`${start_left + this.width / 2},${start_top + this.height}`)
                                                    points.push(`${start_left + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                    if(eJunction === 'top') {
                                                        points.push(`${end_left + this.width + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width + this.width / 2},${end_top - this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${end_top - this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${end_top}`)
                                                    } else if(eJunction === 'right') {
                                                        points.push(`${end_left + this.width + this.width / 2},${start_top  + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                        points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                                    } else if(eJunction === 'bottom') {
                                                        points.push(`${end_left + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${start_top + this.height}`)
                                                    } else if(eJunction === 'left') {
                                                        points.push(`${end_left - this.width  + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left - this.width  + this.width / 2},${start_top + this.height / 2}`)
                                                        points.push(`${end_left},${start_top + this.height / 2}`)
                                                    }
                                                } else if(sJunction === 'left') {
                                                    points.push(`${start_left},${start_top + this.height / 2}`)
                                                    points.push(`${start_left - this.width / 2},${start_top + this.height / 2}`)
                                                    if(eJunction === 'top') {
                                                        points.push(`${start_left - this.width / 2},${start_top - this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${end_top - this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${end_top}`)
                                                    } else if(eJunction === 'right') {
                                                        console.log('从左到右')
                                                        points.push(`${start_left - this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width + this.width / 2},${start_top + this.height / 2}`)
                                                        points.push(`${end_left + this.width},${start_top + this.height / 2}`)
                                                    } else if(eJunction === 'bottom') {
                                                        points.push(`${start_left - this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${start_top + this.height}`)
                                                    } else if(eJunction === 'left') {
                                                        points.push(`${start_left - this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left - this.width  + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left - this.width  + this.width / 2},${start_top + this.height / 2}`)
                                                        points.push(`${end_left},${start_top + this.height / 2}`)
                                                    }
                                                }
                                            }
                                            colleagueLR()
                                        }
                                    } else {
                                        // 间隔的
                                        if(sJunction === 'top') {
                                            points.push(`${start_left + this.width / 2},${start_top}`)
                                            points.push(`${start_left + this.width / 2},${start_top - this.height / 2}`)
                                            if(eJunction === 'top') {
                                                points.push(`${end_left + this.width / 2},${start_top - this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${end_top}`)
                                            } else if(eJunction === 'right') {
                                                points.push(`${end_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                                points.push(`${end_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                            } else if(eJunction === 'bottom') {
                                                points.push(`${end_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                                points.push(`${end_left + this.width + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${end_top + this.height}`)
                                            } else if(eJunction === 'left') {
                                                points.push(`${end_left - this.width / 2},${start_top - this.height / 2}`)
                                                points.push(`${end_left - this.width / 2},${end_top + this.height / 2}`)
                                                points.push(`${end_left},${end_top + this.height / 2}`)
                                            }
                                        } else if(sJunction === 'right') {
                                            points.push(`${start_left + this.width},${start_top + this.height / 2}`)
                                            points.push(`${start_left + this.width + this.width / 2},${start_top + this.height / 2}`)
                                            if(eJunction === 'top') {
                                                points.push(`${start_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${start_top - this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${start_top}`)
                                            } else if(eJunction === 'right') {
                                                points.push(`${start_left + this.width + this.width / 2},${start_top  + this.height + this.height / 2}`)
                                                points.push(`${end_left + this.width + this.width / 2},${start_top  + this.height + this.height / 2}`)
                                                points.push(`${end_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                            } else if(eJunction === 'bottom') {
                                                points.push(`${start_left + this.width + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${start_top + this.height}`)
                                            } else if(eJunction === 'left') {
                                                points.push(`${start_left + this.width + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                points.push(`${end_left - this.width  + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                points.push(`${end_left - this.width  + this.width / 2},${start_top + this.height / 2}`)
                                                points.push(`${end_left},${start_top + this.height / 2}`)
                                            }
                                        } else if(sJunction === 'bottom') {
                                            points.push(`${start_left + this.width / 2},${start_top + this.height}`)
                                            points.push(`${start_left + this.width / 2},${start_top + this.height + this.height / 2}`)
                                            if(eJunction === 'top') {
                                                points.push(`${end_left + this.width + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                points.push(`${end_left + this.width + this.width / 2},${end_top - this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${end_top - this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${end_top}`)
                                            } else if(eJunction === 'right') {
                                                points.push(`${end_left + this.width + this.width / 2},${start_top  + this.height + this.height / 2}`)
                                                points.push(`${end_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                            } else if(eJunction === 'bottom') {
                                                points.push(`${end_left + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${start_top + this.height}`)
                                            } else if(eJunction === 'left') {
                                                points.push(`${end_left - this.width  + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                points.push(`${end_left - this.width  + this.width / 2},${start_top + this.height / 2}`)
                                                points.push(`${end_left},${start_top + this.height / 2}`)
                                            }
                                        } else if(sJunction === 'left') {
                                            points.push(`${start_left},${start_top + this.height / 2}`)
                                            points.push(`${start_left - this.width / 2},${start_top + this.height / 2}`)
                                            if(eJunction === 'top') {
                                                points.push(`${start_left - this.width / 2},${start_top - this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${end_top - this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${end_top}`)
                                            } else if(eJunction === 'right') {
                                                points.push(`${start_left - this.width / 2},${start_top + this.height + this.height / 2}`)
                                                points.push(`${end_left+ this.width + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                points.push(`${end_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                            } else if(eJunction === 'bottom') {
                                                points.push(`${start_left - this.width / 2},${start_top + this.height + this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${start_top + this.height}`)
                                            } else if(eJunction === 'left') {
                                                points.push(`${start_left - this.width / 2},${start_top + this.height + this.height / 2}`)
                                                points.push(`${end_left - this.width  + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                points.push(`${end_left - this.width  + this.width / 2},${start_top + this.height / 2}`)
                                                points.push(`${end_left},${start_top + this.height / 2}`)
                                            }
                                        }
                                    }
                                }

                                // 同一列
                                let sameColumn = () => {
                                    console.log('同一列')

                                    let start_x = start_left + this.width / 2
                                    // 判断开始的坐标是否在结束元素的下边
                                    if(start_top > end_top) {
                                        // 从下往上
                                        let sameColumnBT = () => {
                                            if(sJunction === 'top') {
                                                points.push(`${start_left + this.width / 2},${start_top}`)
                                                if(eJunction === 'top') {
                                                    points.push(`${start_left + this.width / 2},${start_top - this.height / 2}`)
                                                    points.push(`${start_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                                    points.push(`${start_left + this.width + this.width / 2},${end_top - this.height / 2}`)
                                                    points.push(`${start_left + this.width / 2},${end_top - this.height / 2}`)
                                                    points.push(`${start_left + this.width / 2},${end_top}`)
                                                } else if(eJunction === 'right') {
                                                    points.push(`${start_left + this.width / 2},${start_top - this.height / 2}`)
                                                    points.push(`${start_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                                    points.push(`${start_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                    points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                                } else if(eJunction === 'bottom') {
                                                    let distance = Math.abs(start_top - end_top)
                                                    if(distance > this.width * 2) {
                                                        points.push(`${start_left + this.width / 2},${start_top - this.height / 2}`)
                                                        points.push(`${start_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                                        points.push(`${start_left + this.width + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                        points.push(`${start_left + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                        points.push(`${start_left + this.width / 2},${end_top + this.height}`)
                                                    } else {
                                                        console.log('相邻元素')
                                                        points.push(`${start_left + this.width / 2},${end_top + this.height}`)
                                                    }
                                                } else if(eJunction === 'left') {
                                                    points.push(`${start_left + this.width / 2},${start_top - this.height / 2}`)
                                                    points.push(`${start_left - this.width / 2},${start_top - this.height / 2}`)
                                                    points.push(`${start_left - this.width / 2},${end_top + this.height / 2}`)
                                                    points.push(`${end_left},${end_top + this.height / 2}`)
                                                }
                                            } else if(sJunction === 'right') {
                                                points.push(`${start_left + this.width},${start_top + this.height / 2}`)
                                                points.push(`${start_left + this.width + this.width / 2},${start_top + this.height / 2}`)
                                                if(eJunction === 'top') {
                                                    points.push(`${start_left + this.width + this.width / 2},${end_top - this.height / 2}`)
                                                    points.push(`${start_left + this.width / 2},${end_top - this.height / 2}`)
                                                    points.push(`${start_left + this.width / 2},${end_top}`)
                                                } else if(eJunction === 'right') {
                                                    points.push(`${start_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                    points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                                } else if(eJunction === 'bottom') {
                                                    points.push(`${start_left + this.width + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left + this.width / 2},${end_top + this.height}`)
                                                } else if(eJunction === 'left') {
                                                    points.push(`${start_left + this.width + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${start_left - this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${start_left - this.width / 2},${end_top + this.height / 2}`)
                                                    points.push(`${end_left},${end_top + this.height / 2}`)
                                                }
                                            } else if(sJunction === 'bottom') {
                                                points.push(`${start_left + this.width / 2},${start_top + this.height}`)
                                                points.push(`${start_left + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                if(eJunction === 'top') {
                                                    console.log('相邻元素')
                                                    points.push(`${start_left + this.width + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                    points.push(`${start_left + this.width + this.width / 2},${end_top - this.height / 2}`)
                                                    points.push(`${start_left + this.width / 2},${end_top - this.height / 2}`)
                                                    points.push(`${start_left + this.width / 2},${end_top}`)
                                                } else if(eJunction === 'right') {
                                                    points.push(`${start_left + this.width + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                    points.push(`${start_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                    points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                                } else if(eJunction === 'bottom') {
                                                    points.push(`${start_left + this.width + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                    points.push(`${start_left + this.width + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left + this.width / 2},${end_top + this.height}`)
                                                } else if(eJunction === 'left') {
                                                    points.push(`${end_left - this.width / 2},${start_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left - this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left - this.width / 2},${end_top + this.height / 2}`)
                                                    points.push(`${end_left},${end_top + this.height / 2}`)
                                                }
                                            } else if(sJunction === 'left') {
                                                points.push(`${start_left},${start_top + this.height / 2}`)
                                                points.push(`${start_left - this.width / 2},${start_top + this.height / 2}`)
                                                if(eJunction === 'top') {
                                                    points.push(`${start_left - this.width / 2},${end_top - this.height / 2}`)
                                                    points.push(`${end_left + this.width / 2},${end_top - this.height / 2}`)
                                                    points.push(`${end_left + this.width / 2},${end_top}`)
                                                } else if(eJunction === 'right') {
                                                    points.push(`${start_left - this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left + this.width + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                    points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                                } else if(eJunction === 'bottom') {
                                                    points.push(`${start_left - this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left + this.width / 2},${end_top + this.height}`)
                                                } else if(eJunction === 'left') {
                                                    points.push(`${end_left - this.width / 2},${end_top + this.height / 2}`)
                                                    points.push(`${end_left},${end_top + this.height / 2}`)
                                                }
                                            }
                                        }
                                        
                                        sameColumnBT()
                                    } else {
                                        // 从上往下
                                        let sameColumnTB = () => {
                                            console.log('从上往下')

                                            if(sJunction === 'top') {
                                                points.push(`${start_left + this.width / 2},${start_top}`)
                                                if(eJunction === 'top') {
                                                    points.push(`${start_left + this.width / 2},${start_top - this.height / 2}`)
                                                    points.push(`${start_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                                    points.push(`${start_left + this.width + this.width / 2},${end_top - this.height / 2}`)
                                                    points.push(`${start_left + this.width / 2},${end_top - this.height / 2}`)
                                                    points.push(`${start_left + this.width / 2},${end_top}`)
                                                } else if(eJunction === 'right') {
                                                    points.push(`${start_left + this.width / 2},${start_top - this.height / 2}`)
                                                    points.push(`${start_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                                    points.push(`${start_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                    points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                                } else if(eJunction === 'bottom') {
                                                    points.push(`${start_left + this.width / 2},${start_top - this.height / 2}`)
                                                    points.push(`${end_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                                    points.push(`${end_left + this.width + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left + this.width / 2},${end_top + this.height}`)
                                                } else if(eJunction === 'left') {
                                                    points.push(`${start_left + this.width / 2},${start_top - this.height / 2}`)
                                                    points.push(`${start_left - this.width / 2},${start_top - this.height / 2}`)
                                                    points.push(`${start_left - this.width / 2},${end_top + this.height / 2}`)
                                                    points.push(`${end_left},${end_top + this.height / 2}`)
                                                }
                                            } else if(sJunction === 'right') {
                                                points.push(`${start_left + this.width},${start_top + this.height / 2}`)
                                                points.push(`${start_left + this.width + this.width / 2},${start_top + this.height / 2}`)
                                                if(eJunction === 'top') {
                                                    points.push(`${start_left + this.width + this.width / 2},${end_top - this.height / 2}`)
                                                    points.push(`${start_left + this.width / 2},${end_top - this.height / 2}`)
                                                    points.push(`${start_left + this.width / 2},${end_top}`)
                                                } else if(eJunction === 'right') {
                                                    points.push(`${start_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                    points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                                } else if(eJunction === 'bottom') {
                                                    points.push(`${start_left + this.width + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left + this.width / 2},${end_top + this.height}`)
                                                } else if(eJunction === 'left') {
                                                    points.push(`${start_left + this.width + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${start_left - this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${start_left - this.width / 2},${end_top + this.height / 2}`)
                                                    points.push(`${end_left},${end_top + this.height / 2}`)
                                                }
                                            } else if(sJunction === 'bottom') {
                                                points.push(`${start_left + this.width / 2},${start_top + this.height}`)
                                                points.push(`${start_left + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                if(eJunction === 'top') { // 不一样
                                                    console.log('从下往上')
                                                    let distance = Math.abs(start_top - end_top)
                                                    if(distance > this.height * 2) {
                                                        points.push(`${end_left - this.width / 2},${start_top + this.height + this.height / 2}`)
                                                        points.push(`${end_left - this.width / 2},${end_top - this.height / 2}`)
                                                        points.push(`${end_left + this.width / 2},${end_top - this.height / 2}`)                                             
                                                        points.push(`${end_left + this.width / 2},${end_top}`)
                                                    } else {
                                                        console.log('??')
                                                        points.push(`${start_left + this.width / 2},${end_top}`)
                                                    }
                                                } else if(eJunction === 'right') {
                                                    points.push(`${start_left + this.width + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                    points.push(`${start_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                    points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                                } else if(eJunction === 'bottom') {
                                                    points.push(`${start_left + this.width + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                    points.push(`${start_left + this.width + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left + this.width / 2},${end_top + this.height}`)
                                                } else if(eJunction === 'left') { // 不一样
                                                    points.push(`${end_left - this.width / 2},${start_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left - this.width / 2},${end_top + this.height / 2}`)
                                                    points.push(`${end_left},${end_top + this.height / 2}`)
                                                }
                                            } else if(sJunction === 'left') {
                                                points.push(`${start_left},${start_top + this.height / 2}`)
                                                points.push(`${start_left - this.width / 2},${start_top + this.height / 2}`)
                                                if(eJunction === 'top') {
                                                    console.log('从下到上')
                                                    points.push(`${start_left - this.width / 2},${end_top - this.height / 2}`)
                                                    points.push(`${end_left + this.width / 2},${end_top - this.height / 2}`)
                                                    points.push(`${end_left + this.width / 2},${end_top}`)
                                                } else if(eJunction === 'right') {
                                                    points.push(`${start_left - this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left + this.width + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                    points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                                } else if(eJunction === 'bottom') {
                                                    points.push(`${start_left - this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                    points.push(`${end_left + this.width / 2},${end_top + this.height}`)
                                                } else if(eJunction === 'left') {
                                                    points.push(`${end_left - this.width / 2},${end_top + this.height / 2}`)
                                                    points.push(`${end_left},${end_top + this.height / 2}`)
                                                }
                                            }
                                        }
                                        sameColumnTB()
                                    }
                                }

                                // 错位连线
                                let dislocation = () => {
                                    console.log('错位连线')
                                    if(sJunction === 'top') {
                                        points.push(`${start_left + this.width / 2},${start_top}`)
                                        points.push(`${start_left + this.width / 2},${start_top - this.height / 2}`)
                                        if(eJunction === 'top') {
                                            points.push(`${end_left - this.width / 2},${start_top - this.height / 2}`)
                                            points.push(`${end_left - this.width / 2},${end_top - this.height / 2}`)
                                            points.push(`${end_left + this.width / 2},${end_top - this.height / 2}`)
                                            points.push(`${end_left + this.width / 2},${end_top}`)
                                        } else if(eJunction === 'right') {
                                            points.push(`${end_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                            points.push(`${end_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                            points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                        } else if(eJunction === 'bottom') {
                                            if(start_left > end_left) {
                                                console.log('从右到左')
                                                points.push(`${end_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                                points.push(`${end_left + this.width + this.width / 2},${end_top +  this.height + this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${end_top +  this.height + this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${end_top +  this.height}`)
                                            } else {
                                                console.log('从左到右')
                                                points.push(`${end_left - this.width / 2},${start_top - this.height / 2}`)
                                                points.push(`${end_left - this.width / 2},${end_top + this.height + this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${end_top + this.height + this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${end_top + this.height}`)
                                            }
                                        } else if(eJunction === 'left') {
                                            points.push(`${end_left - this.width / 2},${start_top - this.height / 2}`)
                                            points.push(`${end_left - this.width / 2},${end_top + this.height / 2}`)
                                            points.push(`${end_left},${end_top + this.height / 2}`)
                                        }
                                    } else if(sJunction === 'right') {
                                        points.push(`${start_left + this.width},${start_top + this.height / 2}`)
                                        points.push(`${start_left + this.width + this.width / 2},${start_top + this.height / 2}`)
                                        if(eJunction === 'top') {
                                            if(start_left > end_left) {
                                                // 从右往左
                                                points.push(`${start_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                                points.push(`${end_left - this.width / 2},${start_top - this.height / 2}`)
                                            } else {
                                                points.push(`${start_left + this.width + this.width / 2},${end_top - this.height / 2}`)
                                            }
                                            points.push(`${end_left - this.width / 2},${end_top - this.height / 2}`)
                                            points.push(`${end_left + this.width / 2},${end_top - this.height / 2}`)
                                            points.push(`${end_left + this.width / 2},${end_top}`)
                                        } else if(eJunction === 'right') {
                                            points.push(`${start_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                            points.push(`${end_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                            points.push(`${end_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                            points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                        } else if(eJunction === 'bottom') {
                                            console.log('右到下')
                                            points.push(`${start_left + this.width + this.width / 2},${end_top + this.height + this.height / 2}`)
                                            points.push(`${end_left + this.width / 2},${end_top + this.height + this.height / 2}`)
                                            points.push(`${end_left + this.width / 2},${end_top}`)
                                        } else if(eJunction === 'left') {
                                            // 从右往左
                                            console.log('从右往左')
                                            if(start_top > end_top) {
                                                console.log('从下往上')
                                                points.push(`${start_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                                points.push(`${end_left - this.width / 2},${start_top - this.height / 2}`)
                                                points.push(`${end_left - this.width / 2},${end_top + this.height / 2}`)
                                                points.push(`${end_left},${end_top + this.height / 2}`)
                                            } else {
                                                console.log('从上往下')
                                                points.push(`${start_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                points.push(`${end_left},${end_top + this.height / 2}`)

                                            }
                                            
                                        }
                                    } else if(sJunction === 'bottom') {
                                        points.push(`${start_left + this.width / 2},${start_top + this.height}`)
                                        points.push(`${start_left + this.width / 2},${start_top + this.height + this.height / 2}`)
                                        if(eJunction === 'top') {
                                            console.log('从下到上')
                                            if(start_left > end_left) {
                                                console.log('从右到左')
                                                points.push(`${start_left - this.width / 2},${start_top + this.height + this.height / 2}`)
                                                points.push(`${start_left - this.width / 2},${end_top - this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${end_top - this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${end_top}`)
                                            } else {
                                                console.log('从左到右?')
                                                points.push(`${end_left - this.width / 2},${start_top + this.height + this.height / 2}`)
                                                points.push(`${end_left - this.width / 2},${end_top - this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${end_top - this.height / 2}`)
                                                points.push(`${end_left + this.width / 2},${end_top}`)
                                                // points.push(`${end_left + this.width / 2},${start_top + this.height + this.height / 2}`)
                                                // points.push(`${end_left + this.width / 2},${end_top}`)
                                            }
                                        } else if(eJunction === 'right') {
                                            console.log('下到右')
                                            points.push(`${end_left + this.width + this.width / 2},${start_top + this.height + this.height / 2}`)
                                            points.push(`${end_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                            points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                            // points.push(`${start_left + this.width + this.width / 2},${start_top + this.height + this.height / 2}`)
                                            // points.push(`${start_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                            // points.push(`${end_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                            // points.push(`${end_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                            // points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                        } else if(eJunction === 'bottom') {
                                            points = points.concat(dislocationBB(start, end))
                                        } else if(eJunction === 'left') {
                                            // console.log('从下往左')
                                            // if(start_left > end_left) {
                                            //     // 从右往左
                                                console.log('PP')
                                                points.push(`${end_left - this.width / 2},${start_top + this.height + this.height / 2}`)
                                                points.push(`${end_left - this.width / 2},${end_top + this.height / 2}`)
                                                points.push(`${end_left},${end_top + this.height / 2}`)

                                            // } else {
                                            //     console.log('gg')
                                            //     // 从左往右
                                            //     points.push(`${end_left - this.width / 2},${start_top + this.height + this.height / 2}`)
                                            //     points.push(`${end_left - this.width / 2},${end_top + this.height / 2}`)
                                            //     points.push(`${end_left},${end_top + this.height / 2}`)                                            
                                            // }
                                        }
                                    } else if(sJunction === 'left') {
                                        console.log('开始是左', eJunction)
                                        points.push(`${start_left},${start_top + this.height / 2}`)
                                        points.push(`${start_left - this.width / 2},${start_top + this.height / 2}`)
                                        if(eJunction === 'top') {
                                            points.push(`${start_left - this.width / 2},${end_top - this.height / 2}`)
                                            points.push(`${end_left + this.width / 2},${end_top - this.height / 2}`)
                                            points.push(`${end_left + this.width / 2},${end_top}`)
                                        } else if(eJunction === 'right') {
                                            let distance = Math.abs(start_left - end_left)
                                            if(distance > this.width * 2) {
                                                points.push(`${start_left - this.width / 2},${start_top - this.height / 2}`)
                                                points.push(`${end_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                                points.push(`${end_left + this.width + this.width / 2},${end_top + this.height / 2}`)
                                                points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                            } else {
                                                points.push(`${start_left - this.width / 2},${end_top + this.height / 2}`)                                        
                                                points.push(`${end_left + this.width},${end_top + this.height / 2}`)
                                            }
                                        } else if(eJunction === 'bottom') {
                                            points.push(`${start_left - this.width / 2},${end_top + this.height + this.height / 2}`)
                                            points.push(`${end_left + this.width / 2},${end_top + this.height + this.height / 2}`)
                                            points.push(`${end_left + this.width / 2},${end_top + this.height}`)
                                        } else if(eJunction === 'left') {
                                            console.log('从左到左')
                                            points.push(`${start_left - this.width / 2},${start_top - this.height / 2}`)
                                            points.push(`${start_left + this.width + this.width / 2},${start_top - this.height / 2}`)
                                            points.push(`${end_left - this.width / 2},${start_top - this.height / 2}`)
                                            points.push(`${end_left - this.width / 2},${end_top + this.height / 2}`)
                                            points.push(`${end_left},${end_top + this.height / 2}`)
                                        }
                                    }
                                }

                                if(start_top === end_top) { // 同一行
                                    colleague()
                                } else if(start_left === end_left) { // 同一列
                                    sameColumn()
                                } else { // 错位连线
                                    dislocation()
                                }

                                let obj = {
                                    coordinate: points.join(' '),   // 坐标
                                    start: $(start).attr('id'),     // 开始元素的 id
                                    end: $(end).attr('id'),         // 结束元素的 id
                                    sJunction: sJunction,           // 开始的方向
                                    eJunction: eJunction            // 结束的方向
                                }
                                return obj
                            }

                            // 获取所有元素的坐标范围
                            My.prototype.getEleAllPoints = function() {
                                let ele = $('.content .item')
                                this.itemEle = ele
                                for(let i = 0, length = ele.length; i < length; i++) {
                                    let obj = ele[i].getBoundingClientRect()
                                    this.limitedScope.push({
                                        top: obj.top,
                                        left: obj.left
                                    })
                                }
                            }
                            
                            // 判断两个元素连接点的方向,返回坐标
                            My.prototype.ifDirection = function(className) {
                                if(className.includes('item-top')) {
                                    return 'top'
                                } else if(className.includes('item-right')) {
                                    return 'right'
                                } else if(className.includes('item-bottom')) {
                                    return 'bottom'
                                } else if(className.includes('item-left')) {
                                    return 'left'
                                }
                            }

                            // 移动提示线条
                            My.prototype.moveTipLine = function() {
                                // 设置结束坐标
                                this.line.attr("x2", this.end_x).attr("y2", this.end_y)
                            }

                            // 鼠标抬起后的复杂逻辑
                            My.prototype.mouseupLogic = function() {
                                // 判断当前状态: 点击元素 || 点击连接点-进行连线
                                if(this.isDrag) {
                                    // 元素拖动
                                    console.log('元素拖动', this.endEle)
                                    let className = this.endEle ? this.endEle.getAttribute('class') : null
                                    if(this.endEle === null || className.includes('item-content')) {
                                        // 还原初始状态
                                        this.cloneEle.remove()
                                    } else {
                                        // 移动
                                        this.cloneEle && this.cloneEle.remove()
                                        this.endEle.append(this.startEle)

                                        // 判断元素是否存在已有连线
                                        this.isExistentialConnection()
                                    }
                                } else if(this.startEle && this.endEle && this.isRepeat()) {
                                    // 提示线条拖动
                                    console.log('提示线条拖动')
                                    // 画线
                                    let potion = this.connection(this.startEle, this.endEle, this.sJunction, this.eJunction)
                                    vueObj.points.push(potion)
                                }

                                // 重置状态
                                this.line && this.line.remove()
                                this.startEle = null
                                this.endEle = null
                                this.sJunction = null
                                this.eJunction = null
                            }

                            // 判断元素是否存在已有连线
                            My.prototype.isExistentialConnection = function() {
                                console.log(this.startEle.getAttribute('id'), 'id')
                                // 获取移动元素的 id
                                let id = this.startEle.getAttribute('id')
                                // 获取此元素的线条
                                let lineArr = document.querySelectorAll(`g[identity*=${id}]`)
                                console.log(lineArr, 'lineArr')
                                let length = lineArr.length
                                // 如果存在已有连线，则重绘连线
                                if(length > 0) {
                                    this.deleteConnection(id)
                                    this.reDrawLine(lineArr)
                                }
                            }

                            // 删除连线
                            My.prototype.deleteConnection = function(startClassName) {
                                let arr = vueObj.points
                                let length = arr.length
                                let tempArr = []
                                console.log(arr, 'arr')
                                for(let i = 0; i < length; i++) {
                                    let item = arr[i]
                                    let start = item.start
                                    let end = item.end
                                    console.log(item, startClassName, '??')
                                    if(start !== startClassName && end !== startClassName) {
                                        console.log('**')
                                        tempArr.push(item)
                                    }
                                }

                                vueObj.points = tempArr
                            }

                            // 初始化连线
                            My.prototype.initialize = function(arr) {
                                let length = arr.length
                                for(let i = 0; i < length; i++) {
                                    let item = arr[i]
                                    let startEle = document.getElementById(item.start)
                                    let endEle = document.getElementById(item.end)
                                    let potion = this.connection(startEle, endEle, item.sJunction, item.eJunction)
                                    vueObj.points.push(potion)
                                }
                            }

                            // 判断两个元素连接点的方向,返回坐标
                            My.prototype.isDirection = function(class_name) {
                                if(class_name.includes('item-top')) {
                                    return 'top'
                                } else if(class_name.includes('item-right')) {
                                    return 'right'
                                } else if(class_name.includes('item-bottom')) {
                                    return 'bottom'
                                } else if(class_name.includes('item-left')) {
                                    return 'left'
                                }
                            }

                            // 重绘连线
                            My.prototype.reDrawLine = function(lineArr) {
                                let length = lineArr.length
                                let arr = []
                                for(let i = 0; i < length; i++) {
                                    let item = lineArr[i]
                                    let identity = item.getAttribute('identity').split('&')
                                    let obj = {
                                        start: identity[0],
                                        end: identity[1],
                                        sJunction: item.getAttribute('s-junction'),
                                        eJunction: item.getAttribute('e-junction')
                                    }
                                    vueObj.polyline.push(obj)
                                    arr.push(obj)
                                }
                                this.initialize(arr)
                            }

                            // 划过连线: 显示剪刀
                            My.prototype.mousemoveConnection = function() {
                                let target = this.polylineEle.nextElementSibling
                                target.style.display = 'block'
                                target.setAttribute('x', this.end_x - 10)
                                target.setAttribute('y', this.end_y - 10)
                                this.deleteEle = target
                            }

                            // 判断是否重复连线 || 错误连线
                            My.prototype.isRepeat = function() {
                                let arr = vueObj.points
                                let length = arr.length
                                let start = this.startEle.getAttribute('id')
                                let end = this.endEle.getAttribute('id')

                                // 如果开始元素和结束元素是同一个元素则停止
                                if(this.startEle === this.endEle) {
                                    return false
                                }

                                // 判断是否重复连线
                                for(let i = 0; i < length; i++) {
                                    let item = arr[i]
                                    if(item.start === start && item.end === end && item.sJunction === this.sJunction && item.eJunction === this.eJunction) {
                                        console.log('重复连线')
                                        return false
                                    }
                                }
                                return true
                            }

                            new My()
                        },
                        // 删除连线
                        deleteLine(index) {
                            this.points.splice(index, 1)
                        }
                    }
                })
            }

            $(function() {
                let svg = d3.select('#line-box')
                let defs = svg.append('defs')
                let arrow_marker = defs.append('marker')
                    .attr('id', 'arrow')
                    .attr('markerUnits', 'strokeWidth')
                    .attr('markerWidth', 12)
                    .attr('markerHeight', 12)
                    .attr('viewBox', '0 0 12 12')
                    .attr('refX', 9)
                    .attr('refY', 6)
                    .attr('orient', 'auto')

                let arrow_path = 'M2,2 L10,6 L2,10 L6,6 L2,2'
                arrow_marker.append('path').attr('d', arrow_path).attr('fill', this.line_color)

                main()
            })
        </script>
    </body>
</html>
